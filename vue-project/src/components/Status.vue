<template>
  <div>
    <h2>Status em tempo real</h2>

    <label>Selecionar caÃ§a:</label>
    <select v-model="selectedFlight">
      <option value="flight-1">Flight 1</option>
      <option value="flight-2">Flight 2</option>
    </select>

    <div v-if="!connected">ğŸ”´ Desconectado</div>
    <div v-else>ğŸŸ¢ Conectado</div>

    <ul>
      <li>Altitude: {{ data.altitude }} m</li>
      <li>Velocidade: {{ data.speed }} km/h</li>
      <li>DireÃ§Ã£o: {{ data.heading }}Â°</li>
      <li>Temperatura: {{ data.temperature }} Â°C</li>
    </ul>
  </div>
</template>

<script setup>
import { ref, reactive, watch, onMounted, onUnmounted } from 'vue'
import { io } from 'socket.io-client'

const selectedFlight = ref('flight-1')
const connected = ref(false)

const data = reactive({
  altitude: 0,
  speed: 0,
  heading: 0,
  temperature: 0,
})

const socket = io('http://localhost:3000')

let currentListener = ''

const listenToFlight = (flightId) => {
  // remove listener anterior
  if (currentListener) {
    socket.off(currentListener)
  }

  const eventName = `flightData:${flightId}`
  currentListener = eventName

  socket.on(eventName, (incoming) => {
    Object.assign(data, incoming)
  })
}

onMounted(() => {
  socket.on('connect', () => {
    connected.value = true
    console.log('ğŸŸ¢ Conectado ao servidor')
    listenToFlight(selectedFlight.value)
  })

  socket.on('disconnect', () => {
    connected.value = false
    console.log('ğŸ”´ Desconectado')
  })
})

// sempre que o usuÃ¡rio trocar o caÃ§a
watch(selectedFlight, (newFlightId) => {
  if (connected.value) {
    listenToFlight(newFlightId)
  }
})

onUnmounted(() => {
  socket.disconnect()
})
</script>
